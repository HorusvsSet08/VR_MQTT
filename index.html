<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HORUS STATION - VR</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="js/aframe.js"></script>
  <script src="js/paho.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
  <a-scene background="color: #001020" vr-mode-ui="enabled: true" device-orientation-permission-ui="enabled: false">
    
    <!-- Â¡TÃš estÃ¡s aquÃ­! (posiciÃ³n de la cÃ¡mara) -->
    <a-entity position="0 1.6 0">
      <a-camera>
        <a-cursor color="#00aaff" fuse="false"></a-cursor>
      </a-camera>
    </a-entity>

    <!-- Luces -->
    <a-light type="ambient" color="#555" intensity="0.6"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="1 5 3"></a-light>

    <!-- Suelo con rejilla -->
    <a-plane rotation="-90 0 0" width="50" height="50" color="#002244" opacity="0.2" transparent="true"></a-plane>
    <a-entity position="0 0.01 0" rotation="-90 0 0" 
              geometry="primitive: plane; width: 50; height: 50" 
              material="color: #003366; transparent: true; opacity: 0.1">
    </a-entity>

    <!-- TÃTULO "HORUS STATION" EN LOS 4 LADOS (mÃ¡s lejos) -->
    <!-- Norte -->
    <a-entity position="0 2.8 -5.5">
      <a-entity look-at="[camera]">
        <a-text value="ðŸ“¡ HORUS STATION" color="#00eaff" align="center" 
                width="12" font="exo2bold" shader="flat"
                animation="property: position; from: 0 2.8 -5.5; to: 0 3.0 -5.5; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
        </a-text>
      </a-entity>
    </a-entity>
    
    <!-- Sur -->
    <a-entity position="0 2.8 5.5">
      <a-entity look-at="[camera]">
        <a-text value="ðŸ“¡ HORUS STATION" color="#00eaff" align="center" 
                width="12" font="exo2bold" shader="flat"
                animation="property: position; from: 0 2.8 5.5; to: 0 3.0 5.5; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
        </a-text>
      </a-entity>
    </a-entity>
    
    <!-- Este -->
    <a-entity position="5.5 2.8 0">
      <a-entity look-at="[camera]">
        <a-text value="ðŸ“¡ HORUS STATION" color="#00eaff" align="center" 
                width="12" font="exo2bold" shader="flat"
                animation="property: position; from: 5.5 2.8 0; to: 5.5 3.0 0; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
        </a-text>
      </a-entity>
    </a-entity>
    
    <!-- Oeste -->
    <a-entity position="-5.5 2.8 0">
      <a-entity look-at="[camera]">
        <a-text value="ðŸ“¡ HORUS STATION" color="#00eaff" align="center" 
                width="12" font="exo2bold" shader="flat"
                animation="property: position; from: -5.5 2.8 0; to: -5.5 3.0 0; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
        </a-text>
      </a-entity>
    </a-entity>

    <!-- Indicador de conexiÃ³n frente a ti -->
    <a-entity position="0 2.4 0">
      <a-sphere id="status-led" radius="0.15" color="#f00" metalness="0.8"></a-sphere>
      <a-text id="status-text" value="Conectando..." color="#DDD" position="0 -0.3 0" 
              align="center" width="5" shader="flat"></a-text>
    </a-entity>

    <!-- DATOS ALREDEDOR DE TI (a 4.0m, altura 2.0m) -->
    <!-- Temperatura - frente a ti -->
    <a-entity position="0 2.0 -4.0">
      <a-entity look-at="[camera]">
        <a-text id="temp-text" value="ðŸŒ¡ï¸ --Â°C" color="#FF5722" align="center" 
                width="4.5" font="exo2bold" shader="flat" 
                text="wrapCount: 10"></a-text>
        <a-text value="TEMPERATURA" color="#FFF" position="0 -0.7 0" align="center" 
                width="4.5" font="roboto" shader="flat" 
                text="wrapCount: 10"></a-text>
      </a-entity>
    </a-entity>

    <!-- Humedad - derecha -->
    <a-entity position="2.8 2.0 -2.8">
      <a-entity look-at="[camera]">
        <a-text id="hum-text" value="ðŸ’§ --%" color="#2196F3" align="center" 
                width="4.5" font="exo2bold" shader="flat" 
                text="wrapCount: 10"></a-text>
        <a-text value="HUMEDAD" color="#FFF" position="0 -0.7 0" align="center" 
                width="4.5" font="roboto" shader="flat" 
                text="wrapCount: 10"></a-text>
      </a-entity>
    </a-entity>

    <!-- PresiÃ³n - derecha delante -->
    <a-entity position="4.0 2.0 0">
      <a-entity look-at="[camera]">
        <a-text id="press-text" value="ðŸ”½ -- hPa" color="#9E9E9E" align="center" 
                width="5.5" font="exo2bold" shader="flat" 
                text="wrapCount: 12"></a-text>
        <a-text value="PRESIÃ“N" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>

    <!-- Altitud - izquierda delante -->
    <a-entity position="-4.0 2.0 0">
      <a-entity look-at="[camera]">
        <a-text id="alt-text" value="â›°ï¸ -- m" color="#673AB7" align="center" 
                width="4.5" font="exo2bold" shader="flat" 
                text="wrapCount: 10"></a-text>
        <a-text value="ALTITUD" color="#FFF" position="0 -0.7 0" align="center" 
                width="4.5" font="roboto" shader="flat" 
                text="wrapCount: 10"></a-text>
      </a-entity>
    </a-entity>

    <!-- PM2.5 - izquierda -->
    <a-entity position="-2.8 2.0 -2.8">
      <a-entity look-at="[camera]">
        <a-text id="pm25-text" value="ðŸŒ«ï¸ -- Î¼g/mÂ³" color="#FF9800" align="center" 
                width="5.5" font="exo2bold" shader="flat" 
                text="wrapCount: 12"></a-text>
        <a-text value="PM2.5" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>

    <!-- PM10 - atrÃ¡s derecha -->
    <a-entity position="2.8 2.0 2.8">
      <a-entity look-at="[camera]">
        <a-text id="pm10-text" value="ðŸŒ«ï¸ -- Î¼g/mÂ³" color="#F44336" align="center" 
                width="5.5" font="exo2bold" shader="flat" 
                text="wrapCount: 12"></a-text>
        <a-text value="PM10" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>

    <!-- Viento (velocidad) - atrÃ¡s -->
    <a-entity position="0 2.0 4.0">
      <a-entity look-at="[camera]">
        <a-text id="wind-text" value="ðŸ’¨ -- m/s" color="#4CAF50" align="center" 
                width="5.5" font="exo2bold" shader="flat" 
                text="wrapCount: 12"></a-text>
        <a-text value="VIENTO" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>

    <!-- Gas - atrÃ¡s izquierda (como porcentaje) -->
    <a-entity position="-2.8 2.0 2.8">
      <a-entity look-at="[camera]">
        <a-text id="gas-text" value="â›½ --%" color="#FFEB3B" align="center" 
                width="5.5" font="exo2bold" shader="flat" 
                text="wrapCount: 12"></a-text>
        <a-text value="GAS" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>

    <!-- Lluvia - derecha atrÃ¡s (como sÃ­/no) -->
    <a-entity position="3.4 2.0 1.4">
      <a-entity look-at="[camera]">
        <a-text id="rain-text" value="ðŸŒ§ï¸ no" color="#2196F3" align="center" 
                width="4.5" font="exo2bold" shader="flat" 
                text="wrapCount: 10"></a-text>
        <a-text value="LLUVIA" color="#FFF" position="0 -0.7 0" align="center" 
                width="4.5" font="roboto" shader="flat" 
                text="wrapCount: 10"></a-text>
      </a-entity>
    </a-entity>

    <!-- DirecciÃ³n del viento - izquierda atrÃ¡s -->
    <a-entity position="-3.4 2.0 1.4">
      <a-entity look-at="[camera]">
        <a-text id="winddir-text" value="ðŸ§­ --Â°" color="#E91E63" align="center" 
                width="4.5" font="exo2bold" shader="flat" 
                text="wrapCount: 10"></a-text>
        <a-text value="DIR. VIENTO" color="#FFF" position="0 -0.7 0" align="center" 
                width="5.5" font="roboto" shader="flat" 
                text="wrapCount: 12"></a-text>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ConfiguraciÃ³n MQTT (WSS seguro)
    const broker = "broker.hivemq.com";
    const port = 8884; // Puerto WSS (seguro)
    const clientId = "vr-horus-" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

    // Elementos UI
    const led = document.getElementById("status-led");
    const statusText = document.getElementById("status-text");

    function setConnected(connected) {
      led.setAttribute("color", connected ? "#0f0" : "#f00");
      statusText.setAttribute("value", connected ? "Conectado âœ…" : "Sin conexiÃ³n âŒ");
      led.setAttribute("animation", connected ?
        "property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 800; easing: easeInOutSine; loop: true" :
        "property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: 1000; easing: easeInOutSine; loop: true");
    }

    function decodeUTF8(str) {
      try {
        return decodeURIComponent(escape(str));
      } catch (e) {
        return str;
      }
    }

    // Eventos MQTT
    client.onConnectionLost = () => setConnected(false);

    client.onMessageArrived = (message) => {
      const topic = message.destinationName;
      let payload = decodeUTF8(message.payloadString.trim());

      // Ajustar: Lluvia y Gas como porcentajes
      if (topic === "horus/vvb/lluvia") {
        const raining = ["1", "true", "si", "yes", "sÃ­", "rain"].includes(payload.toLowerCase());
        document.getElementById("rain-text").setAttribute("value", `ðŸŒ§ï¸ ${raining ? "sÃ­" : "no"}`);
      }
      else if (topic === "horus/vvb/gas") {
        const gasValue = parseFloat(payload);
        if (!isNaN(gasValue)) {
          const percent = Math.max(0, Math.min(100, (100 - gasValue / 10))).toFixed(1);
          document.getElementById("gas-text").setAttribute("value", `â›½ ${percent}%`);
        } else {
          document.getElementById("gas-text").setAttribute("value", `â›½ 0%`);
        }
      }
      else {
        // Para todos los demÃ¡s, solo mostrar valor
        switch (topic) {
          case "horus/vvb/temperatura":
            document.getElementById("temp-text").setAttribute("value", `ðŸŒ¡ï¸ ${payload}Â°C`);
            break;
          case "horus/vvb/humedad":
            document.getElementById("hum-text").setAttribute("value", `ðŸ’§ ${payload}%`);
            break;
          case "horus/vvb/presion":
            document.getElementById("press-text").setAttribute("value", `ðŸ”½ ${payload} hPa`);
            break;
          case "horus/vvb/altitud":
            document.getElementById("alt-text").setAttribute("value", `â›°ï¸ ${payload} m`);
            break;
          case "horus/vvb/pm25":
            document.getElementById("pm25-text").setAttribute("value", `ðŸŒ«ï¸ ${payload} Î¼g/mÂ³`);
            break;
          case "horus/vvb/pm10":
            document.getElementById("pm10-text").setAttribute("value", `ðŸŒ«ï¸ ${payload} Î¼g/mÂ³`);
            break;
          case "horus/vvb/wind_speed":
            document.getElementById("wind-text").setAttribute("value", `ðŸ’¨ ${payload} m/s`);
            break;
          case "horus/vvb/wind_direction":
            document.getElementById("winddir-text").setAttribute("value", `ðŸ§­ ${payload}Â°`);
            break;
        }
      }

      setConnected(true);
    };

    // Conectar al cargar
    window.addEventListener("load", () => {
      client.connect({
        useSSL: true,
        onSuccess: () => {
          setConnected(true);
          const topics = [
            "horus/vvb/temperatura",
            "horus/vvb/humedad",
            "horus/vvb/presion",
            "horus/vvb/altitud",
            "horus/vvb/pm25",
            "horus/vvb/pm10",
            "horus/vvb/wind_speed",
            "horus/vvb/wind_direction",
            "horus/vvb/gas",
            "horus/vvb/lluvia"
          ];
          
          topics.forEach(topic => {
            client.subscribe(topic, {
              onSuccess: () => console.log(`Suscrito a ${topic}`),
              onFailure: (error) => console.error(`Error suscribiendo a ${topic}:`, error)
            });
          });
        },
        onFailure: (error) => {
          setConnected(false);
          console.error("Error MQTT:", error.errorMessage || error);
        }
      });
    });
  </script>
</body>
</html>
