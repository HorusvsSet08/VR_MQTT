<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estaci√≥n Horus - VR</title>
  <!-- Librer√≠as locales -->
  <script src="js/aframe.js"></script>
  <script src="js/paho.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
  <a-scene background="color: #001020" vr-mode-ui="enabled: true">

    <!-- C√°mara -->
    <a-entity position="0 1.6 8">
      <a-camera>
        <a-cursor color="#00aaff"></a-cursor>
      </a-camera>
    </a-entity>

    <!-- Luces -->
    <a-light type="ambient" color="#555" intensity="0.6"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="1 5 3"></a-light>

    <!-- Suelo con rejilla -->
    <a-entity position="0 0 0">
      <a-plane rotation="-90 0 0" width="50" height="50" color="#002244" opacity="0.2" transparent="true"></a-plane>
      <a-entity
        geometry="primitive: plane; width: 50; height: 50"
        material="color: #003366; transparent: true; opacity: 0.1"
        position="0 0.01 0"
        rotation="-90 0 0">
      </a-entity>
    </a-entity>

    <!-- T√≠tulo principal -->
    <a-text
      value="üì° ESTACI√ìN HORUS"
      color="#00eaff"
      position="0 3.5 -5"
      align="center"
      width="16"
      font="exo2bold"
      animation="property: position; from: 0 3.5 -5; to: 0 3.7 -5; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
    </a-text>

    <!-- Indicador de conexi√≥n en 3D -->
    <a-entity position="0 2.8 -5">
      <a-sphere id="status-led" radius="0.15" color="#f00" metalness="0.8"></a-sphere>
      <a-text id="status-text" value="Conectando..." color="#DDD" position="0 -0.3 0" align="center" width="5"></a-text>
    </a-entity>

    <!-- Sensores: solo n√∫meros grandes -->
    <!-- Temperatura -->
    <a-entity position="-5 1.2 -2">
      <a-text id="temp-text" value="üå°Ô∏è --¬∞C" color="#FF5722" position="0 0 0" align="center" width="4" font="exo2bold" shader="flat"></a-text>
      <a-text value="TEMPERATURA" color="#FFF" position="0 -0.6 0" align="center" width="4" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Humedad -->
    <a-entity position="-3.5 1.2 -4.5">
      <a-text id="hum-text" value="üíß --%" color="#2196F3" position="0 0 0" align="center" width="4" font="exo2bold" shader="flat"></a-text>
      <a-text value="HUMEDAD" color="#FFF" position="0 -0.6 0" align="center" width="4" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Presi√≥n -->
    <a-entity position="0 1.2 -7">
      <a-text id="press-text" value="üîΩ -- hPa" color="#9E9E9E" position="0 0 0" align="center" width="5" font="exo2bold" shader="flat"></a-text>
      <a-text value="PRESI√ìN" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Altitud -->
    <a-entity position="3.5 1.2 -4.5">
      <a-text id="alt-text" value="‚õ∞Ô∏è -- m" color="#673AB7" position="0 0 0" align="center" width="4" font="exo2bold" shader="flat"></a-text>
      <a-text value="ALTITUD" color="#FFF" position="0 -0.6 0" align="center" width="4" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- PM2.5 -->
    <a-entity position="5 1.2 -2">
      <a-text id="pm25-text" value="üå´Ô∏è -- Œºg/m¬≥" color="#FF9800" position="0 0 0" align="center" width="5" font="exo2bold" shader="flat"></a-text>
      <a-text value="PM2.5" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- PM10 -->
    <a-entity position="-5 1.2 -7">
      <a-text id="pm10-text" value="üå´Ô∏è -- Œºg/m¬≥" color="#F44336" position="0 0 0" align="center" width="5" font="exo2bold" shader="flat"></a-text>
      <a-text value="PM10" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Viento (velocidad) -->
    <a-entity position="-2 1.2 -9">
      <a-text id="wind-text" value="üí® -- m/s" color="#4CAF50" position="0 0 0" align="center" width="5" font="exo2bold" shader="flat"></a-text>
      <a-text value="VIENTO" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Gas -->
    <a-entity position="2 1.2 -9">
      <a-text id="gas-text" value="‚õΩ -- kŒ©" color="#FFEB3B" position="0 0 0" align="center" width="5" font="exo2bold" shader="flat"></a-text>
      <a-text value="GAS" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Lluvia -->
    <a-entity position="5 1.2 -7">
      <a-text id="rain-text" value="üåßÔ∏è no" color="#2196F3" position="0 0 0" align="center" width="4" font="exo2bold" shader="flat"></a-text>
      <a-text value="LLUVIA" color="#FFF" position="0 -0.6 0" align="center" width="4" font="roboto" shader="flat"></a-text>
    </a-entity>

    <!-- Direcci√≥n del viento -->
    <a-entity position="0 1.2 -11">
      <a-text id="winddir-text" value="üß≠ --¬∞" color="#E91E63" position="0 0 0" align="center" width="4" font="exo2bold" shader="flat"></a-text>
      <a-text value="DIR VIENTO" color="#FFF" position="0 -0.6 0" align="center" width="5" font="roboto" shader="flat"></a-text>
    </a-entity>

  </a-scene>

  <script>
    // Configuraci√≥n MQTT (WSS seguro)
    const broker = "broker.hivemq.com";
    const port = 8884;
    const clientId = "vr-horus-" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

    // Elementos de UI
    const led = document.getElementById("status-led");
    const statusText = document.getElementById("status-text");

    // Funci√≥n para actualizar estado
    function setConnected(connected) {
      led.setAttribute("color", connected ? "#0f0" : "#f00");
      statusText.setAttribute("value", connected ? "Conectado ‚úÖ" : "Sin conexi√≥n ‚ùå");
      led.setAttribute("animation", connected ?
        "property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 800; easing: easeInOutSine; loop: true" :
        "property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: 1000; easing: easeInOutSine; loop: true");
    }

    // Eventos MQTT
    client.onConnectionLost = () => setConnected(false);

    client.onMessageArrived = (message) => {
      const topic = message.destinationName;
      const payload = message.payloadString.trim();

      // Actualiza seg√∫n el t√≥pico
      switch (topic) {
        case "horus/vvb/temperatura":
          document.getElementById("temp-text").setAttribute("value", `üå°Ô∏è ${payload}¬∞C`);
          break;

        case "horus/vvb/humedad":
          document.getElementById("hum-text").setAttribute("value", `üíß ${payload}%`);
          break;

        case "horus/vvb/presion":
          document.getElementById("press-text").setAttribute("value", `üîΩ ${payload} hPa`);
          break;

        case "horus/vvb/altitud":
          document.getElementById("alt-text").setAttribute("value", `‚õ∞Ô∏è ${payload} m`);
          break;

        case "horus/vvb/pm25":
          document.getElementById("pm25-text").setAttribute("value", `üå´Ô∏è ${payload} Œºg/m¬≥`);
          break;

        case "horus/vvb/pm10":
          document.getElementById("pm10-text").setAttribute("value", `üå´Ô∏è ${payload} Œºg/m¬≥`);
          break;

        case "horus/vvb/wind_speed":
          document.getElementById("wind-text").setAttribute("value", `üí® ${payload} m/s`);
          break;

        case "horus/vvb/wind_direction":
          document.getElementById("winddir-text").setAttribute("value", `üß≠ ${payload}¬∞`);
          break;

        case "horus/vvb/gas":
          document.getElementById("gas-text").setAttribute("value", `‚õΩ ${payload} kŒ©`);
          break;

        case "horus/vvb/lluvia":
          const raining = ["1", "true", "si", "yes", "rain"].includes(payload.toLowerCase());
          document.getElementById("rain-text").setAttribute("value", `üåßÔ∏è ${raining ? "s√≠" : "no"}`);
          break;
      }

      setConnected(true); // Conectado al recibir cualquier dato
    };

    // Conectar al cargar
    window.addEventListener("load", () => {
      client.connect({
        useSSL: true,
        onSuccess: () => {
          setConnected(true);
          [
            "horus/vvb/temperatura",
            "horus/vvb/humedad",
            "horus/vvb/presion",
            "horus/vvb/altitud",
            "horus/vvb/pm25",
            "horus/vvb/pm10",
            "horus/vvb/wind_speed",
            "horus/vvb/wind_direction",
            "horus/vvb/gas",
            "horus/vvb/lluvia"
          ].forEach(topic => client.subscribe(topic));
        },
        onFailure: (error) => {
          setConnected(false);
          console.error("Error MQTT:", error.errorMessage || error);
        }
      });
    });
  </script>
</body>
</html>
