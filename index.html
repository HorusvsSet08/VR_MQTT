<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estación Horus - VR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <style>
    #connection-status {
      position: absolute;
      top: 10px;
      right: 10px;
      color: white;
      font-family: Arial, sans-serif;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      display: inline-block;
      transition: background 0.3s;
    }
    .led.connected {
      background: #0f0;
    }
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <!-- Indicador de conexión -->
  <div id="connection-status">
    <span class="led" id="led"></span>
    <span id="status-text">Conectando...</span>
  </div>

  <!-- Escena VR con soporte para WebXR y giroscopio -->
  <a-scene vr-mode-ui="enabled: true" device-orientation-permission-ui="enabled: false">
    
    <!-- Cámara con cursor por mirada -->
    <a-entity position="0 1.6 4">
      <a-camera>
        <a-cursor 
          fuse="false" 
          color="#FF4444"
          raycaster="objects: .clickable">
        </a-cursor>
      </a-camera>
    </a-entity>

    <!-- Luces -->
    <a-light type="ambient" color="#444"></a-light>
    <a-light type="directional" color="#FFF" position="0 5 5"></a-light>

    <!-- Suelo -->
    <a-plane rotation="-90 0 0" width="20" height="20" color="#AAA" opacity="0.2" transparent="true"></a-plane>

    <!-- Título -->
    <a-text value="Estación Horus VVB" color="#FFF" position="0 2.2 -3" align="center" width="10"></a-text>

    <!-- Datos: ej. temperatura -->
    <a-box id="temp-bar" position="-3 1 -3" depth="0.2" width="0.5" color="#FF4444" visible="false"></a-box>
    <a-text id="temp-text" value="Temp: --°C" position="-3 0.5 -3" color="#DDD" align="center"></a-text>

    <!-- Más elementos... (como en tu versión) -->
  </a-scene>

  <script>
    // ✅ CORREGIDO: Usa WSS (puerto 8884) para conexión segura
    const broker = "broker.hivemq.com";
    const port = 8884; // ✅ WSS (WebSocket Secure), no 8080
    const clientId = "vr-horus-" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId); // Nota: ruta "/mqtt" requerida

    // UI
    const led = document.getElementById("led");
    const statusText = document.getElementById("status-text");

    function setConnected(connected) {
      if (connected) {
        led.classList.add("connected");
        statusText.textContent = "Conectado ✅";
      } else {
        led.classList.remove("connected");
        statusText.textContent = "Sin conexión ❌";
      }
    }

    client.onConnectionLost = (responseObject) => {
      console.log("Conexión perdida: " + responseObject.errorMessage);
      setConnected(false);
    };

    client.onMessageArrived = (message) => {
      console.log("Mensaje: " + message.payloadString + " en " + message.destinationName);
      // Aquí actualizas tus elementos (como antes)
      setConnected(true);
    };

    // Conectar
    window.addEventListener("load", () => {
      client.connect({
        onSuccess: () => {
          console.log("✅ Conectado a broker.hivemq.com (WSS)");
          setConnected(true);
          client.subscribe("horus/vvb/temperatura");
          client.subscribe("horus/vvb/humedad");
          // Suscribe a más tópicos...
        },
        onFailure: (error) => {
          console.error("❌ Error al conectar:", error);
          setConnected(false);
        },
        useSSL: true // ✅ Obligatorio para WSS
      });
    });
  </script>
</body>
</html>
