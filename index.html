<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estaci√≥n Horus - VR</title>
  <!-- Librer√≠as locales -->
  <script src="js/aframe.js"></script>
  <script src="js/paho.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
  <a-scene background="color: #001220" vr-mode-ui="enabled: true">

    <!-- C√°mara principal -->
    <a-entity position="0 1.6 8">
      <a-camera>
        <a-cursor color="#00aaff" animation__click="property: scale; from: 1 1 1; to: 0.5 0.5 0.5; dur: 100; startEvents: click"></a-cursor>
      </a-camera>
    </a-entity>

    <!-- Luces -->
    <a-light type="ambient" color="#444" intensity="0.6"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="1 5 3"></a-light>

    <!-- Suelo con rejilla y brillo -->
    <a-entity position="0 0 0">
      <a-plane rotation="-90 0 0" width="50" height="50" color="#002244" opacity="0.3" transparent="true"></a-plane>
      <a-entity
        geometry="primitive: plane; width: 50; height: 50"
        material="color: #003366; transparent: true; opacity: 0.1; repeat: 10 10"
        position="0 0.01 0"
        rotation="-90 0 0"
        visible="true">
      </a-entity>
    </a-entity>

    <!-- T√≠tulo flotante con efecto -->
    <a-text
      value="üì° ESTACI√ìN HORUS"
      color="#00eaff"
      position="0 3.5 -5"
      align="center"
      width="16"
      font="exo2bold"
      animation="property: position; from: 0 3.5 -5; to: 0 3.7 -5; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate">
    </a-text>

    <!-- Indicador de conexi√≥n 3D -->
    <a-entity position="0 2.8 -5">
      <a-sphere id="status-led" radius="0.15" color="#f00" metalness="0.8" roughness="0.2"></a-sphere>
      <a-text id="status-text" value="Conectando..." color="#DDD" position="0 -0.3 0" align="center" width="5"></a-text>
    </a-entity>

    <!-- Grupo de sensores: distribuidos en arco -->
    <!-- Temperatura -->
    <a-entity position="-5.5 1.2 -2">
      <a-box id="temp-bar" color="#FF5722" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üå°Ô∏è Temp: --¬∞C" position="0 -0.9 0" color="#FFF" align="center" width="4"></a-text>
    </a-entity>

    <!-- Humedad -->
    <a-entity position="-4 1.2 -4.5">
      <a-box id="hum-bar" color="#2196F3" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üíß Humedad: --%" position="0 -0.9 0" color="#FFF" align="center" width="4"></a-text>
    </a-entity>

    <!-- Presi√≥n -->
    <a-entity position="0 1.2 -7">
      <a-box id="press-bar" color="#9E9E9E" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üîΩ Presi√≥n: -- hPa" position="0 -0.9 0" color="#FFF" align="center" width="5"></a-text>
    </a-entity>

    <!-- Altitud -->
    <a-entity position="4 1.2 -4.5">
      <a-box id="alt-bar" color="#673AB7" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="‚õ∞Ô∏è Altitud: -- m" position="0 -0.9 0" color="#FFF" align="center" width="4"></a-text>
    </a-entity>

    <!-- PM2.5 -->
    <a-entity position="5.5 1.2 -2">
      <a-box id="pm25-bar" color="#FF9800" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üå´Ô∏è PM2.5: -- Œºg/m¬≥" position="0 -0.9 0" color="#FFF" align="center" width="5"></a-text>
    </a-entity>

    <!-- PM10 -->
    <a-entity position="-5.5 1.2 -7">
      <a-box id="pm10-bar" color="#F44336" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üå´Ô∏è PM10: -- Œºg/m¬≥" position="0 -0.9 0" color="#FFF" align="center" width="5"></a-text>
    </a-entity>

    <!-- Viento (velocidad) -->
    <a-entity position="-2 1.2 -9">
      <a-box id="wind-bar" color="#4CAF50" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="üí® Viento: -- m/s" position="0 -0.9 0" color="#FFF" align="center" width="5"></a-text>
    </a-entity>

    <!-- Gas -->
    <a-entity position="2 1.2 -9">
      <a-box id="gas-bar" color="#FFEB3B" depth="0.2" width="0.6" visible="false" shadow></a-box>
      <a-text class="sensor" value="‚õΩ Gas: -- kŒ©" position="0 -0.9 0" color="#FFF" align="center" width="5"></a-text>
    </a-entity>

    <!-- Lluvia -->
    <a-entity position="5.5 1.2 -7">
      <a-cone id="rain-cone" color="#2196F3" radius-bottom="0.35" height="1" visible="false" shadow></a-cone>
      <a-text class="sensor" value="üåßÔ∏è Lluvia: no" position="0 -0.9 0" color="#FFF" align="center" width="4"></a-text>
    </a-entity>

    <!-- Direcci√≥n del viento -->
    <a-entity position="0 1.2 -11">
      <a-entity id="wind-arrow" visible="false">
        <a-cone color="#E91E63" radius-bottom="0.25" height="0.8" rotation="-90 0 0" shadow></a-cone>
        <a-cylinder color="#E91E63" radius="0.06" height="1.3" rotation="-90 0 0" position="0 0 -0.65" shadow></a-cylinder>
      </a-entity>
      <a-text class="sensor" value="üß≠ Dir: --¬∞" position="0 -0.9 0" color="#FFF" align="center" width="4"></a-text>
    </a-entity>

  </a-scene>

  <script>
    // Configuraci√≥n MQTT (WSS seguro)
    const broker = "broker.hivemq.com";
    const port = 8884;
    const clientId = "vr-horus-" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

    // Elementos
    const led = document.getElementById("status-led");
    const statusText = document.getElementById("status-text");

    // Funci√≥n para actualizar barras
    function updateBar(id, value, max) {
      const bar = document.getElementById(id);
      const height = Math.max(0.1, value / max);
      bar.setAttribute("height", height);
      bar.setAttribute("position", { y: height / 2, z: -3 });
      bar.setAttribute("visible", true);
    }

    // Actualizar estado
    function setConnected(connected) {
      led.setAttribute("color", connected ? "#0f0" : "#f00");
      led.setAttribute("animation", connected ?
        "property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dur: 800; easing: easeInOutSine; loop: true" :
        "property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dur: 1000; easing: easeInOutSine; loop: true");
      statusText.setAttribute("value", connected ? "Conectado ‚úÖ" : "Sin conexi√≥n ‚ùå");
    }

    // Eventos MQTT
    client.onConnectionLost = () => setConnected(false);

    client.onMessageArrived = (message) => {
      const topic = message.destinationName;
      const payload = message.payloadString.trim();

      switch (topic) {
        case "horus/vvb/temperatura":
          const temp = parseFloat(payload);
          if (!isNaN(temp)) {
            document.querySelector('#temp-bar ~ .sensor').setAttribute("value", `üå°Ô∏è Temp: ${temp.toFixed(1)}¬∞C`);
            updateBar("temp-bar", temp, 50);
          }
          break;

        case "horus/vvb/humedad":
          const hum = parseFloat(payload);
          if (!isNaN(hum)) {
            document.querySelector('#hum-bar ~ .sensor').setAttribute("value", `üíß Humedad: ${hum.toFixed(1)}%`);
            updateBar("hum-bar", hum, 100);
          }
          break;

        case "horus/vvb/presion":
          const press = parseFloat(payload);
          if (!isNaN(press)) {
            document.querySelector('#press-bar ~ .sensor').setAttribute("value", `üîΩ Presi√≥n: ${press.toFixed(1)} hPa`);
            updateBar("press-bar", press / 10, 100);
          }
          break;

        case "horus/vvb/altitud":
          const alt = parseFloat(payload);
          if (!isNaN(alt)) {
            document.querySelector('#alt-bar ~ .sensor').setAttribute("value", `‚õ∞Ô∏è Altitud: ${alt.toFixed(1)} m`);
            updateBar("alt-bar", alt / 100, 100);
          }
          break;

        case "horus/vvb/pm25":
          const pm25 = parseFloat(payload);
          if (!isNaN(pm25)) {
            document.querySelector('#pm25-bar ~ .sensor').setAttribute("value", `üå´Ô∏è PM2.5: ${pm25} Œºg/m¬≥`);
            updateBar("pm25-bar", pm25, 100);
          }
          break;

        case "horus/vvb/pm10":
          const pm10 = parseFloat(payload);
          if (!isNaN(pm10)) {
            document.querySelector('#pm10-bar ~ .sensor').setAttribute("value", `üå´Ô∏è PM10: ${pm10} Œºg/m¬≥`);
            updateBar("pm10-bar", pm10, 150);
          }
          break;

        case "horus/vvb/wind_speed":
          const wind = parseFloat(payload);
          if (!isNaN(wind)) {
            document.querySelector('#wind-bar ~ .sensor').setAttribute("value", `üí® Viento: ${wind.toFixed(1)} m/s`);
            updateBar("wind-bar", wind, 20);
          }
          break;

        case "horus/vvb/wind_direction":
          const dir = parseFloat(payload);
          if (!isNaN(dir)) {
            document.querySelector('#wind-arrow ~ .sensor').setAttribute("value", `üß≠ Dir: ${dir.toFixed(1)}¬∞`);
            document.getElementById("wind-arrow").setAttribute("rotation", { y: -dir });
            document.getElementById("wind-arrow").setAttribute("visible", true);
          }
          break;

        case "horus/vvb/gas":
          const gas = parseFloat(payload);
          if (!isNaN(gas)) {
            document.querySelector('#gas-bar ~ .sensor').setAttribute("value", `‚õΩ Gas: ${gas.toFixed(1)} kŒ©`);
            updateBar("gas-bar", gas / 100, 10);
          }
          break;

        case "horus/vvb/lluvia":
          const raining = ["1", "true", "si", "yes", "rain"].includes(payload.toLowerCase());
          document.getElementById("rain-cone").setAttribute("visible", raining);
          document.querySelector('#rain-cone ~ .sensor').setAttribute("value", `üåßÔ∏è Lluvia: ${raining ? "s√≠" : "no"}`);
          break;
      }

      setConnected(true); // Conectado al recibir cualquier dato
    };

    // Conectar al cargar
    window.addEventListener("load", () => {
      client.connect({
        useSSL: true,
        onSuccess: () => {
          setConnected(true);
          [
            "horus/vvb/temperatura",
            "horus/vvb/humedad",
            "horus/vvb/presion",
            "horus/vvb/altitud",
            "horus/vvb/pm25",
            "horus/vvb/pm10",
            "horus/vvb/wind_speed",
            "horus/vvb/wind_direction",
            "horus/vvb/gas",
            "horus/vvb/lluvia"
          ].forEach(topic => client.subscribe(topic));
        },
        onFailure: (error) => {
          setConnected(false);
          console.error("Error MQTT:", error.errorMessage || error);
        }
      });
    });
  </script>
</body>
</html>
