<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HORUS STATION - DASHBOARD</title>
  <!-- Cargar A-Frame 1.4.2 (versi√≥n compatible con tu entorno) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  
  <!-- Cargar Paho MQTT con la URL CORRECTA y VERIFICADA -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
  
  <!-- Biblioteca para el joystick -->
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
  
  <style>
    /* Estilos mejorados aqu√≠ (mismos que en la versi√≥n anterior) */
    :root {
      --primary: #00eaff;
      --primary-dark: #00aaff;
      --dark-bg: #000a1a;
      --panel-bg: #0a1a30;
      --card-bg: #152540;
      --text: #e0e0e0;
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --shadow: 0 10px 30px rgba(0, 20, 50, 0.3);
      --glow: 0 0 15px rgba(0, 234, 255, 0.5);
    }
    
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--dark-bg), #000510);
      color: var(--text);
      height: 100vh;
    }
    
    #connection-status {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1000;
      padding: 10px 18px;
      background: rgba(0, 10, 30, 0.7);
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(0, 234, 255, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    
    .led {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.7);
    }
    
    .led.connected {
      background: #0f0;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.7);
    }
    
    #vr-button {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: none;
    }
    
    #joystick-container {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 100px;
      height: 100px;
      z-index: 999;
      display: none;
    }
    
    .sensor-card {
      position: relative;
      overflow: hidden;
      border-radius: var(--border-radius);
      background: var(--card-bg);
      padding: 18px 20px;
      text-align: center;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .sensor-value {
      font-size: 26px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .unit {
      font-size: 16px;
      color: #a0a0a0;
    }
  </style>
</head>
<body>
  <!-- Indicador de conexi√≥n -->
  <div id="connection-status">
    <span class="led" id="connection-led"></span>
    <span id="connection-text">Conectando...</span>
  </div>
  
  <!-- Bot√≥n VR para m√≥viles -->
  <button id="vr-button" class="mobile-only">üï∂Ô∏è</button>
  
  <!-- Joystick para m√≥viles -->
  <div id="joystick-container" class="mobile-only"></div>
  
  <!-- Escena 3D -->
  <a-scene id="main-scene" embedded style="width: 100%; height: 100vh;" vr-mode-ui="enabled: false">
    <a-entity id="camera-rig" position="0 1.6 4">
      <a-entity id="camera" camera look-controls>
        <a-cursor color="#00eaff" fuse="false"></a-cursor>
      </a-entity>
    </a-entity>
    
    <!-- Luces -->
    <a-light type="ambient" color="#555" intensity="0.6"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="1 5 3"></a-light>
    
    <!-- Suelo -->
    <a-plane rotation="-90 0 0" width="50" height="50" color="#002244" opacity="0.2"></a-plane>
    
    <!-- Panel de datos -->
    <a-entity id="dashboard" position="0 1.8 -4">
      <a-plane width="6" height="3.5" color="#0a1a30" opacity="0.9" transparent="true"></a-plane>
      
      <a-text value="ESTACI√ìN HORUS" color="#00eaff" position="0 1.3 0.1" align="center" width="5.5" font="exo2bold"></a-text>
      
      <!-- Temperatura -->
      <a-entity position="-2 0.7 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="üå°Ô∏è TEMPERATURA" color="#FF5722" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="temp-value" value="--" color="#FF5722" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
        <a-text value="¬∞C" color="#a0a0a0" position="0.4 -0.05 0.1" align="center" width="1.5" font="roboto" class="unit"></a-text>
      </a-entity>
      
      <!-- Humedad -->
      <a-entity position="-0.5 0.7 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="üíß HUMEDAD" color="#2196F3" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="hum-value" value="--" color="#2196F3" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
        <a-text value="%" color="#a0a0a0" position="0.4 -0.05 0.1" align="center" width="1.5" font="roboto" class="unit"></a-text>
      </a-entity>
      
      <!-- Presi√≥n -->
      <a-entity position="1 0.7 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="üîΩ PRESI√ìN" color="#9E9E9E" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="press-value" value="--" color="#9E9E9E" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
        <a-text value="hPa" color="#a0a0a0" position="0.5 -0.05 0.1" align="center" width="1.5" font="roboto" class="unit"></a-text>
      </a-entity>
      
      <!-- Altitud -->
      <a-entity position="-2 -0.3 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="‚õ∞Ô∏è ALTITUD" color="#673AB7" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="alt-value" value="--" color="#673AB7" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
        <a-text value="m" color="#a0a0a0" position="0.3 -0.05 0.1" align="center" width="1.5" font="roboto" class="unit"></a-text>
      </a-entity>
      
      <!-- Gas -->
      <a-entity position="-0.5 -0.3 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="‚õΩ GAS" color="#FFEB3B" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="gas-value" value="--" color="#FFEB3B" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
        <a-text value="%" color="#a0a0a0" position="0.4 -0.05 0.1" align="center" width="1.5" font="roboto" class="unit"></a-text>
      </a-entity>
      
      <!-- Lluvia -->
      <a-entity position="1 -0.3 0.1" class="sensor-card">
        <a-plane width="1.8" height="1.2" color="#152540" opacity="0.9" transparent="true" radius="0.2"></a-plane>
        <a-text value="üåßÔ∏è LLUVIA" color="#2196F3" position="0 0.25 0.1" align="center" width="1.5" font="roboto"></a-text>
        <a-text id="rain-value" value="no" color="#2196F3" position="0 -0.05 0.1" align="center" width="1.5" font="exo2bold"></a-text>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // Verificaci√≥n robusta de la biblioteca Paho
    function checkPahoReady() {
      // Si Paho est√° disponible, inicializamos MQTT
      if (typeof Paho !== 'undefined' && typeof Paho.MQTT !== 'undefined') {
        console.log("Paho MQTT est√° listo para usarse");
        initMQTT();
        return true;
      }
      
      console.log("Paho MQTT no est√° disponible todav√≠a. Reintentando en 500ms...");
      setTimeout(checkPahoReady, 500);
      return false;
    }

    // Inicializar conexi√≥n MQTT
    function initMQTT() {
      try {
        // Verificar expl√≠citamente que Paho.Client existe
        if (typeof Paho === 'undefined' || typeof Paho.MQTT === 'undefined' || typeof Paho.MQTT.Client === 'undefined') {
          throw new Error("Paho.Client no est√° definido. La biblioteca no se carg√≥ correctamente.");
        }

        // Configuraci√≥n MQTT
        const mqttServer = "broker.hivemq.com";
        const mqttPort = 8000; // Puerto para WebSocket
        const mqttClientId = "web-client-" + Math.random().toString(36).substr(2, 9);
        
        // Crear cliente MQTT
        const client = new Paho.MQTT.Client(mqttServer, mqttPort, "/mqtt", mqttClientId);
        
        // Configurar callbacks
        client.onConnectionLost = (responseObject) => {
          console.log("Conexi√≥n MQTT perdida:", responseObject.errorMessage);
          updateConnectionStatus(false);
          
          // Reintentar conexi√≥n
          setTimeout(() => {
            initMQTT();
          }, 5000);
        };
        
        client.onMessageArrived = (message) => {
          const topic = message.destinationName;
          const payload = message.payloadString;
          console.log(`Mensaje recibido - ${topic}: ${payload}`);
          updateDashboard(topic, payload);
          updateConnectionStatus(true);
        };
        
        // Conectar
        client.connect({
          onSuccess: () => {
            console.log("Conexi√≥n MQTT establecida");
            updateConnectionStatus(true);
            
            // Suscribirse a los temas
            const topics = [
              "horus/vvb/temperatura",
              "horus/vvb/humedad",
              "horus/vvb/presion",
              "horus/vvb/altitud",
              "horus/vvb/gas",
              "horus/vvb/lluvia"
            ];
            
            topics.forEach(topic => {
              client.subscribe(topic, {
                onSuccess: () => console.log(`Suscrito a ${topic}`),
                onFailure: (error) => console.error(`Error suscribiendo a ${topic}:`, error)
              });
            });
          },
          onFailure: (error) => {
            console.error("Error al conectar MQTT:", error.errorMessage);
            updateConnectionStatus(false, error.errorMessage);
            
            // Reintentar conexi√≥n
            setTimeout(() => {
              initMQTT();
            }, 5000);
          }
        });
      } catch (error) {
        console.error("Error cr√≠tico al inicializar MQTT:", error);
        updateConnectionStatus(false, "Error cr√≠tico");
        
        // Mostrar mensaje de error espec√≠fico
        const connectionText = document.getElementById('connection-text');
        connectionText.textContent = `Error: ${error.message}`;
        
        // Reintentar inicializaci√≥n
        setTimeout(() => {
          initMQTT();
        }, 5000);
      }
    }
    
    // Actualizar estado de conexi√≥n
    function updateConnectionStatus(connected, message = "") {
      const connectionLed = document.getElementById('connection-led');
      const connectionText = document.getElementById('connection-text');
      
      connectionLed.className = connected ? "led connected" : "led";
      connectionText.textContent = connected ? "Conectado" : (message || "Desconectado");
    }
    
    // Actualizar el dashboard con los datos recibidos
    function updateDashboard(topic, payload) {
      if (topic === "horus/vvb/temperatura") {
        document.getElementById('temp-value').setAttribute('text', `value: ${payload}`);
      } else if (topic === "horus/vvb/humedad") {
        document.getElementById('hum-value').setAttribute('text', `value: ${payload}`);
      } else if (topic === "horus/vvb/presion") {
        document.getElementById('press-value').setAttribute('text', `value: ${payload}`);
      } else if (topic === "horus/vvb/altitud") {
        document.getElementById('alt-value').setAttribute('text', `value: ${payload}`);
      } else if (topic === "horus/vvb/gas") {
        document.getElementById('gas-value').setAttribute('text', `value: ${payload}`);
      } else if (topic === "horus/vvb/lluvia") {
        const raining = ["1", "true", "si", "yes", "s√≠", "rain"].includes(payload.toLowerCase());
        document.getElementById('rain-value').setAttribute('text', `value: ${raining ? 's√≠' : 'no'}`);
      }
    }
    
    // Inicializar el joystick para m√≥viles
    function initJoystick() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (!isMobile) return;
      
      // Mostrar controles m√≥viles
      document.getElementById('vr-button').style.display = 'flex';
      document.getElementById('joystick-container').style.display = 'block';
      
      // Obtener referencias a la c√°mara
      const cameraRig = document.getElementById('camera-rig');
      const camera = document.getElementById('camera');
      
      if (!cameraRig || !camera) {
        console.error("No se encontraron elementos de c√°mara");
        return;
      }
      
      // Configurar el joystick
      const joystick = nipplejs.create({
        zone: document.getElementById('joystick-container'),
        size: 100,
        threshold: 0.1,
        color: 'rgba(0, 234, 255, 0.7)'
      });
      
      // Manejar el movimiento
      joystick.on('move', (evt, data) => {
        if (!cameraRig || !camera) return;
        
        const angle = data.angle.radian;
        const force = data.force;
        
        // Calcular movimiento
        const moveSpeed = 0.05 * force;
        const dx = Math.sin(angle) * moveSpeed;
        const dz = Math.cos(angle) * moveSpeed;
        
        // Actualizar posici√≥n
        const currentPos = cameraRig.getAttribute('position');
        cameraRig.setAttribute('position', {
          x: currentPos.x - dx,
          y: currentPos.y,
          z: currentPos.z - dz
        });
      });
    }
    
    // Cambiar a modo VR
    function enterVRMode() {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) {
        scene.enterVR();
      }
    }
    
    // Inicializar la aplicaci√≥n
    window.addEventListener('load', () => {
      // Verificar y esperar a que Paho est√© listo
      checkPahoReady();
      
      // Inicializar joystick
      initJoystick();
      
      // Configurar bot√≥n VR
      document.getElementById('vr-button').addEventListener('click', enterVRMode);
    });
  </script>
</body>
</html>
