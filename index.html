<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HORUS STATION - AR</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <!-- Librerías para AR -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="js/paho.js"></script>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    #connection-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 8px;
    }
    #connection-indicator .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
    }
    #connection-indicator .led.connected {
      background: #0f0;
    }
    #top-title {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(0, 0, 0, 0.6);
      color: #00eaff;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 0 5px rgba(0, 234, 255, 0.5);
    }
    #ar-instructions {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- Indicador de conexión FIJO -->
  <div id="connection-indicator">
    <span class="led" id="status-led-ui"></span>
    <span id="status-text-ui">Desconectado</span>
  </div>
  
  <!-- Título superior FIJO -->
  <div id="top-title">HORUS STATION - AR</div>
  
  <!-- Instrucciones para AR -->
  <div id="ar-instructions">
    Apunta la cámara a una superficie plana para colocar el panel
  </div>

  <a-scene 
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    device-orientation-permission-ui="enabled: false"
    vr-mode-ui="enabled: false">
    
    <!-- Panel AR (se colocará sobre una superficie) -->
    <a-entity 
      position="0 0 0"
      rotation="0 0 0"
      look-at="[camera]"
      id="dashboard-panel">
      
      <!-- Marco del panel -->
      <a-plane width="1.2" height="0.7" color="#0a1a30" opacity="0.85" transparent="true" rotation="0 0 0" position="0 0.35 0"></a-plane>
      <a-plane width="1.18" height="0.68" color="#001020" opacity="0.9" transparent="true" rotation="0 0 0" position="0 0.35 0.01"></a-plane>
      
      <!-- FILA 1: Temperatura y Humedad -->
      <a-entity position="-0.4 0.5 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="temp-text" value="-- °C" color="#FF5722" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0 0.5 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="hum-text" value="-- %" color="#2196F3" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0.4 0.5 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="press-text" value="-- hPa" color="#9E9E9E" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <!-- FILA 2: Altitud, PM2.5 y PM10 -->
      <a-entity position="-0.4 0.2 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="alt-text" value="-- m" color="#673AB7" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0 0.2 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="pm25-text" value="--" color="#FF9800" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0.4 0.2 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="pm10-text" value="--" color="#F44336" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <!-- FILA 3: Viento, Gas y Lluvia -->
      <a-entity position="-0.4 -0.1 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="wind-text" value="--" color="#4CAF50" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0 -0.1 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="gas-text" value="--" color="#FFEB3B" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <a-entity position="0.4 -0.1 0.01">
        <a-plane width="0.4" height="0.25" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="rain-text" value="no" color="#2196F3" position="0 0 0" 
                align="center" width="0.35" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.3; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
      
      <!-- Dirección del viento (grande, en el centro inferior) -->
      <a-entity position="0 -0.35 0.01">
        <a-plane width="0.65" height="0.18" color="#152540" opacity="0.7" transparent="true" radius="0.03"></a-plane>
        <a-text id="winddir-text" value="--" color="#E91E63" position="0 0 0" 
                align="center" width="0.6" font="exo2bold" shader="flat" 
                text="shader: sdf; baseline: center; width: 0.6; letterSpacing: 5; whiteSpace: nowrap"></a-text>
      </a-entity>
    </a-entity>

    <!-- Ancla para AR (se coloca en superficies horizontales) -->
    <a-entity 
      id="ar-marker"
      geometry="primitive: plane; width: 0.5; height: 0.5" 
      material="color: #00ff00; opacity: 0.3; transparent: true"
      rotation="-90 0 0"
      position="0 -0.01 0">
    </a-entity>

    <!-- Cámara AR -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Configuración MQTT (WSS seguro)
    const broker = "broker.hivemq.com";
    const port = 8884; // Puerto WSS (seguro)
    const clientId = "ar-horus-" + Math.random().toString(16).substr(2, 8);
    const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

    // Elementos UI (interfaz fija)
    const ledUI = document.getElementById("status-led-ui");
    const statusTextUI = document.getElementById("status-text-ui");

    function setConnected(connected) {
      // Actualizar interfaz fija
      ledUI.className = connected ? "led connected" : "led";
      statusTextUI.textContent = connected ? "Conectado" : "Desconectado";
    }

    function decodeUTF8(str) {
      try {
        return decodeURIComponent(escape(str));
      } catch (e) {
        return str;
      }
    }

    // Eventos MQTT
    client.onConnectionLost = () => setConnected(false);

    client.onMessageArrived = (message) => {
      const topic = message.destinationName;
      let payload = decodeUTF8(message.payloadString.trim());

      // Ajustar: Lluvia y Gas como porcentajes
      if (topic === "horus/vvb/lluvia") {
        const raining = ["1", "true", "si", "yes", "sí", "rain"].includes(payload.toLowerCase());
        document.getElementById("rain-text").setAttribute("value", raining ? "sí" : "no");
      }
      else if (topic === "horus/vvb/gas") {
        const gasValue = parseFloat(payload);
        if (!isNaN(gasValue)) {
          const percent = Math.max(0, Math.min(100, (100 - gasValue / 10))).toFixed(1);
          document.getElementById("gas-text").setAttribute("value", `${percent}%`);
        } else {
          document.getElementById("gas-text").setAttribute("value", "0%");
        }
      }
      else {
        // Para todos los demás, solo mostrar valor
        switch (topic) {
          case "horus/vvb/temperatura":
            document.getElementById("temp-text").setAttribute("value", `${payload}°C`);
            break;
          case "horus/vvb/humedad":
            document.getElementById("hum-text").setAttribute("value", `${payload}%`);
            break;
          case "horus/vvb/presion":
            document.getElementById("press-text").setAttribute("value", `${payload}hPa`);
            break;
          case "horus/vvb/altitud":
            document.getElementById("alt-text").setAttribute("value", `${payload}m`);
            break;
          case "horus/vvb/pm25":
            document.getElementById("pm25-text").setAttribute("value", payload);
            break;
          case "horus/vvb/pm10":
            document.getElementById("pm10-text").setAttribute("value", payload);
            break;
          case "horus/vvb/wind_speed":
            document.getElementById("wind-text").setAttribute("value", `${payload}m/s`);
            break;
          case "horus/vvb/wind_direction":
            document.getElementById("winddir-text").setAttribute("value", `${payload}°`);
            break;
        }
      }

      setConnected(true);
    };

    // Conectar al cargar
    window.addEventListener("load", () => {
      // Esperar a que AR.js esté listo
      setTimeout(() => {
        client.connect({
          useSSL: true,
          onSuccess: () => {
            setConnected(true);
            const topics = [
              "horus/vvb/temperatura",
              "horus/vvb/humedad",
              "horus/vvb/presion",
              "horus/vvb/altitud",
              "horus/vvb/pm25",
              "horus/vvb/pm10",
              "horus/vvb/wind_speed",
              "horus/vvb/wind_direction",
              "horus/vvb/gas",
              "horus/vvb/lluvia"
            ];
            
            topics.forEach(topic => {
              client.subscribe(topic, {
                onSuccess: () => console.log(`Suscrito a ${topic}`),
                onFailure: (error) => console.error(`Error suscribiendo a ${topic}:`, error)
              });
            });
          },
          onFailure: (error) => {
            setConnected(false);
            console.error("Error MQTT:", error.errorMessage || error);
          }
        });
      }, 2000); // Esperar un poco para que AR.js se inicialice
    });
  </script>
</body>
</html>
